# -*- coding: utf-8 -*-
"""Untitled26.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15gNmXBoN4DhqRZms911rX-kTXhBHlX0D
"""

# M√≥dulos necesarios
from datetime import datetime
from data_models import USUARIOS, RESERVAS, ASIENTOS, CARTELERA, TARIFAS
from validation_utils import validar_documento, validar_nombre, print_errores
from file_manager import exportar_csv_reservas, exportar_csv_usuarios
from report_generator import imprimir_mapa_asientos, generar_reportes, imprimir_reportes, imprimir_usuarios, consultar_funciones_cartelera

# --- Funciones de Actividades del Men√∫ Principal ---

def registrar_usuario():
    """Permite registrar un nuevo usuario con validaciones."""
    print("\n[Registro de Usuario] Paso a paso")

    # 1. Solicitar y validar Documento
    while True:
        documento = input("Ingresa tu documento de identidad: ").strip()
        doc_err = validar_documento(documento)
        if doc_err:
            print_errores(doc_err)
            continue
        if documento in USUARIOS:
            print("\n‚ö†Ô∏è Este documento ya est√° registrado. Volviendo al men√∫ principal.")
            return
        break

    # 2. Solicitar y validar Nombre y Apellido
    while True:
        nombre = input("Ingresa tu nombre: ").strip().title()
        apellido = input("Ingresa tu apellido: ").strip().title()

        nombre_err = validar_nombre(nombre)
        apellido_err = validar_nombre(apellido)

        if nombre_err or apellido_err:
            print_errores([f"Nombre: {e}" for e in nombre_err] + [f"Apellido: {e}" for e in apellido_err])
            continue
        break

    # 3. Seleccionar Tipo de V√≠nculo
    while True:
        print("\nTipos de v√≠nculo disponibles:")
        for key, data in TARIFAS.items():
            print(f"  {key}. {data['vinculo']} - ${data['valor']:,}")

        try:
            opcion_vinculo = int(input("Selecciona el n√∫mero de tu tipo de v√≠nculo: "))
            if opcion_vinculo in TARIFAS:
                datos_vinculo = TARIFAS[opcion_vinculo]
                break
            else:
                print("Opci√≥n de v√≠nculo inv√°lida. Intenta de nuevo.")
        except ValueError:
            print("Entrada inv√°lida. Debe ser un n√∫mero.")

    # 4. Registrar y Exportar
    USUARIOS[documento] = {
        "nombre": nombre,
        "apellido": apellido,
        "vinculo": datos_vinculo["vinculo"],
        "valor": datos_vinculo["valor"]
    }

    print(f"\nüéâ ¬°Usuario {nombre} registrado con √©xito como {datos_vinculo['vinculo']}! Tarifa: ${datos_vinculo['valor']:,}")
    exportar_csv_usuarios()

def seleccionar_funcion():
    """Muestra la cartelera y permite seleccionar una funci√≥n."""
    print("\n--- Cartelera de Funciones ---")
    funciones_disponibles = []

    for i, f in enumerate(CARTELERA):
        mapa = ASIENTOS.get(i, {})
        disponibles = sum(1 for estado in mapa.values() if estado == 'O')

        if disponibles > 0:
            funciones_disponibles.append(i)
            print(f"[{i+1}] {f['dia']} {f['hora']} - {f['nombre']} | Asientos Disponibles: {disponibles}")

    if not funciones_disponibles:
        print("‚ö†Ô∏è Lo sentimos, no hay funciones disponibles en este momento.")
        return None

    while True:
        try:
            opcion = int(input("\nSelecciona el n√∫mero de la funci√≥n: "))
            idx_funcion = opcion - 1
            if idx_funcion in funciones_disponibles:
                return idx_funcion
            else:
                print("Opci√≥n de funci√≥n inv√°lida o sin asientos disponibles. Intenta de nuevo.")
        except ValueError:
            print("Entrada inv√°lida. Debe ser un n√∫mero.")

def solicitar_asiento(idx_funcion):
    """Permite al usuario seleccionar un asiento disponible."""
    imprimir_mapa_asientos(idx_funcion, ASIENTOS)
    mapa = ASIENTOS[idx_funcion]

    while True:
        asiento = input("Ingresa el asiento que deseas reservar (Ej: A1, B10, K11): ").strip().upper()

        if asiento not in mapa:
            print("Asiento inv√°lido. Debe ser una combinaci√≥n de Fila(A-K) y Columna(1-11).")
        elif mapa[asiento] == 'X':
            print("Ese asiento ya est√° ocupado. Selecciona uno marcado con 'O'.")
        else:
            return asiento

def confirmar_compra(documento, idx_funcion, asiento):
    """Finaliza el proceso de reserva y genera la factura."""
    datos_usuario = USUARIOS[documento]
    funcion = CARTELERA[idx_funcion]
    valor = datos_usuario["valor"]

    # 1. Registrar Reserva
    RESERVAS.append({
        "documento": documento,
        "idx_funcion": idx_funcion,
        "asiento": asiento,
        "valor": valor,
        "fecha_reserva": datetime.now().strftime("%Y-%m-%d")
    })

    # 2. Ocupar Asiento
    ASIENTOS[idx_funcion][asiento] = 'X'

    # 3. Generar Factura
    print("\n" + "="*40)
    print("        [FACTURA DE COMPRA]")
    print("="*40)
    print(f"USUARIO: {datos_usuario['nombre']} {datos_usuario['apellido']}")
    print(f"DOCUMENTO: {documento}")
    print("-" * 40)
    print(f"FUNCI√ìN: {funcion['nombre']}")
    print(f"D√çA/HORA: {funcion['dia']} {funcion['hora']}")
    print(f"ASIENTO: {asiento}")
    print(f"V√çNCULO: {datos_usuario['vinculo']}")
    print("-" * 40)
    print(f"VALOR PAGADO: ${valor:,}")
    print("="*40)

    exportar_csv_reservas()
    print("\n‚úÖ ¬°Reserva registrada con √©xito!")

def registrar_reserva():
    """Flujo completo para registrar una reserva."""
    documento = input("\nIngresa tu documento de identidad para reservar: ").strip()

    doc_err = validar_documento(documento)
    if doc_err:
        print_errores(doc_err)
        return

    if documento not in USUARIOS:
        print("\n‚ö†Ô∏è No est√°s registrado. Por favor, reg√≠strate primero (Opci√≥n 1).")
        return

    idx_funcion = seleccionar_funcion()
    if idx_funcion is None:
        return

    asiento = solicitar_asiento(idx_funcion)

    if asiento:
        confirmar_compra(documento, idx_funcion, asiento)

def cancelar_reserva(documento):
    """Permite al usuario cancelar una de sus reservas activas."""
    reservas_usuario = [r for r in RESERVAS if r["documento"] == documento]

    if not reservas_usuario:
        print("\n‚ö†Ô∏è No tienes reservas activas. Volviendo al men√∫ principal.")
        return

    print("\n--- Tus Reservas Activas ---")
    for i, r in enumerate(reservas_usuario):
        f = CARTELERA[r["idx_funcion"]]
        print(f"[{i+1}] {f['nombre']} - {f['dia']} {f['hora']} - Asiento: {r['asiento']}")

    while True:
        try:
            opcion = input("Ingresa el n√∫mero de la reserva a cancelar o '0' para salir: ").strip()

            if opcion == '0':
                print("Cancelaci√≥n anulada.")
                return

            idx_cancelar = int(opcion) - 1

            if 0 <= idx_cancelar < len(reservas_usuario):
                reserva_a_cancelar = reservas_usuario[idx_cancelar]

                # 1. Liberar Asiento
                idx_funcion = reserva_a_cancelar["idx_funcion"]
                asiento = reserva_a_cancelar["asiento"]
                ASIENTOS[idx_funcion][asiento] = 'O'

                # 2. Eliminar del registro global (se busca y elimina la primera coincidencia)
                RESERVAS.remove(reserva_a_cancelar)

                print(f"\nüóëÔ∏è Reserva de {reserva_a_cancelar['asiento']} en {CARTELERA[idx_funcion]['nombre']} cancelada con √©xito. Asiento liberado.")
                exportar_csv_reservas()
                break
            else:
                print("Opci√≥n inv√°lida. Intenta de nuevo.")
        except ValueError:
            print("Entrada inv√°lida. Debe ser un n√∫mero.")

def menu_administrador():
    """Men√∫ de opciones para el administrador."""
    while True:
        print("\n--- MEN√ö ADMINISTRADOR ---")
        print("1. Consultar Reportes (1, 2, 3, 4, 6)")
        print("5. Lista de usuarios registrados")
        print("7. Exportar CSV (usuarios y reservas)")
        print("8. Volver al Men√∫ Principal")

        op = input("Selecciona una opci√≥n: ").strip()

        if op == '1':
            total_reservas, total_recaudo, promedio_diario, usuario_max, usuario_min = generar_reportes()
            imprimir_reportes(total_reservas, total_recaudo, promedio_diario, usuario_max, usuario_min)
        elif op == '5':
            imprimir_usuarios(USUARIOS)
        elif op == '7':
            exportar_csv_usuarios()
            exportar_csv_reservas()
        elif op == '8':
            break
        else:
            print("Opci√≥n inv√°lida. Intenta de nuevo.")

def admin_login():
    """Protege el acceso al men√∫ de administrador."""
    admins = {"admin": "admin123", "po_udea": "cinema2025"}

    usuario = input("Usuario Admin: ").strip()
    password = input("Contrase√±a Admin: ").strip()

    if usuario in admins and admins[usuario] == password:
        print("\nüîë Acceso de administrador concedido.")
        menu_administrador()
    else:
        print("\n‚ùå Credenciales inv√°lidas. Acceso denegado.")